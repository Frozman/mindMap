"use strict";angular.module("mindMapApp",["controller"]);var module=angular.module("controller",[]);module.controller("MainCtrl",["$scope",function(a){function b(a){var c={};c.name=a.name;var d=a.children||a._children,e=[];return d&&(d.forEach(function(a){e.push(b(a))}),c.children=e),c}a.root=null,a.fileName="mindMap",d3.json("data/data.json",function(b){a.json=b,a.$apply()}),a.new=function(){a.json={name:"root"}},a.load=function(b){var c=new FileReader;c.onload=function(b){var c=b.target.result;a.json=JSON.parse(c),a.$apply()},c.readAsText(b)},a.save=function(){var c=b(a.root),d="application/json",e=new Blob([JSON.stringify(c)],{type:d}),f=document.createElement("a");f.download=a.fileName+".json",f.href=window.URL.createObjectURL(e),f.textContent="點擊下載",f.dataset.downloadurl=[d,f.download,f.href].join(":"),document.querySelectorAll("#downloadLinkWrap")[0].innerHTML="",document.querySelectorAll("#downloadLinkWrap")[0].appendChild(f)}}]),module.directive("mindMap",function(){return{link:function(a,b){function c(a){a.children?(a._children=a.children,a.children=null):(a.children=a._children,a._children=null)}function d(a){var b=500;if(null!=a){var c=m.nodes(f).reverse(),d=0,g=j;c.forEach(function(a){d<a.depth&&(d=a.depth)}),g=Math.floor(j/(d+1)),c.forEach(function(a){a.y=a.depth*g});var h=o.selectAll("g.node").data(c,function(a){return a.id||(a.id=++l)}),i=h.enter().append("svg:g").attr("class","node").attr("transform",function(){return"translate("+a.y0+","+a.x0+")"});e(i);var k=h.transition().duration(b).attr("transform",function(a){return"translate("+a.y+","+a.x+")"});k.select("circle").attr("r",4.5).style("fill",function(a){return a._children?"lightsteelblue":"#fff"}),k.select("text").text(function(a){return a.name}).style("fill-opacity",1);var p=h.exit().transition().duration(b).attr("transform",function(){return"translate("+a.y+","+a.x+")"}).remove();p.select("circle").attr("r",1e-6),p.select("text").style("fill-opacity",1e-6);var q=o.selectAll("path.link").data(m.links(c),function(a){return a.target.id});q.enter().insert("svg:path","g").attr("class","link").attr("d",function(){var b={x:a.x0,y:a.y0};return n({source:b,target:b})}).transition().duration(b).attr("d",n),q.transition().duration(b).attr("d",n),q.exit().transition().duration(b).attr("d",function(){var b={x:a.x,y:a.y};return n({source:b,target:b})}).remove(),c.forEach(function(a){a.x0=a.x,a.y0=a.y})}}function e(b){function e(b){var c;b.children?c=b.children:b._children?(c=b.children=b._children,b._children=null):(c=[],b.children=c),c.push({depth:b.depth+1,name:"new Node",parent:b}),d(b),a.root=f}function g(b){var c=b.id;return b.parent?(b.parent.children.forEach(function(a,d){return c===a.id?(b.parent.children.splice(d,1),void 0):void 0}),d(b.parent),a.root=f,void 0):(alert("沒辦法刪除Root"),void 0)}function h(b){var c=prompt("輸入新的名稱",b.name);null!=c&&(b.name=c),b.parent||d(b),d(b.parent),a.root=f}b.append("svg:circle").attr("r",1e-6).style("fill",function(a){return a._children?"lightsteelblue":"#fff"}).classed("toggleCircle",!0).on("click",function(a){c(a),d(a)}),b.append("svg:text").attr("x",function(a){return a.children||a._children?-10:10}).attr("dy",".35em").attr("text-anchor",function(a){return a.children||a._children?"end":"start"}).text(function(a){return a.name}).style("fill-opacity",1e-6),b.append("svg:path").attr("d","M12 24c-6.627 0-12-5.372-12-12s5.373-12 12-12c6.628 0 12 5.372 12 12s-5.372 12-12 12zM12 3c-4.97 0-9 4.030-9 9s4.030 9 9 9c4.971 0 9-4.030 9-9s-4.029-9-9-9zM13.5 18h-3v-4.5h-4.5v-3h4.5v-4.5h3v4.5h4.5v3h-4.5v4.5z").attr("transform",function(a){var b=a.children||a._children?-70:0;return"translate("+b+",10)"}).classed("function-btn add",!0),b.append("svg:rect").classed("function-bg add",!0).attr("width","24px").attr("height","24px").attr("transform",function(a){var b=a.children||a._children?-70:0;return"translate("+b+",10)"}).on("click",e),b.append("svg:path").attr("d","M3.514 20.485c-4.686-4.686-4.686-12.284 0-16.97 4.688-4.686 12.284-4.686 16.972 0 4.686 4.686 4.686 12.284 0 16.97-4.688 4.687-12.284 4.687-16.972 0zM18.365 5.636c-3.516-3.515-9.214-3.515-12.728 0-3.516 3.515-3.516 9.213 0 12.728 3.514 3.515 9.213 3.515 12.728 0 3.514-3.515 3.514-9.213 0-12.728zM8.818 17.303l-2.121-2.122 3.182-3.182-3.182-3.182 2.121-2.122 3.182 3.182 3.182-3.182 2.121 2.122-3.182 3.182 3.182 3.182-2.121 2.122-3.182-3.182-3.182 3.182z").attr("transform",function(a){var b=a.children||a._children?-40:30;return"translate("+b+",10)"}).classed("function-btn remove",!0),b.append("svg:rect").classed("function-bg remove",!0).attr("width","24px").attr("height","24px").attr("transform",function(a){var b=a.children||a._children?-40:30;return"translate("+b+",10)"}).on("click",g),b.append("svg:path").attr("d","M20.307 1.998c-0.839-0.462-3.15-1.601-4.658-1.913-1.566-0.325-3.897 5.79-4.638 5.817-1.202 0.043-0.146-4.175 0.996-5.902-1.782 1.19-4.948 2.788-5.689 4.625-1.432 3.551 2.654 9.942 0.474 10.309-0.68 0.114-2.562-4.407-3.051-5.787-1.381 2.64-0.341 5.111 0.801 8.198v0.192c-0.044 0.167-0.082 0.327-0.121 0.489h0.121v4.48c0 0.825 0.668 1.493 1.493 1.493 0.825 0 1.493-0.668 1.493-1.493v-4.527c2.787-0.314 4.098 0.6 6.007-3.020-1.165 0.482-3.491-0.987-3.009-1.68 0.97-1.396 4.935 0.079 7.462-4.211-4 1.066-4.473-0.462-4.511-1.019-0.080-1.154 3.999-0.542 5.858-2.146 1.078-0.93 2.37-3.133 0.97-3.905z").attr("transform",function(a){var b=a.children||a._children?-10:60;return"translate("+b+",10)"}).classed("function-btn edit",!0),b.append("svg:rect").classed("function-bg edit",!0).attr("width","24px").attr("height","24px").attr("transform",function(a){var b=a.children||a._children?-10:60;return"translate("+b+",10)"}).on("click",h)}var f,g=b[0].clientWidth,h=b[0].clientHeight,i=[20,40,20,80],j=g-i[1]-i[3],k=h-i[0]-i[2],l=0,m=d3.layout.tree().size([k,j]),n=d3.svg.diagonal().projection(function(a){return[a.y,a.x]}),o=d3.select(b[0]).append("svg:svg").attr("width",j+i[1]+i[3]).attr("height",k+i[0]+i[2]).append("svg:g").attr("transform","translate("+i[3]+","+i[0]+")");a.$watch("json",function(){null==a.json&&(a.json={name:"root"}),f=a.json,f.x0=k/2,f.y0=0,d(f),a.root=f})}}}),module.directive("changeFile",function(){return{scope:{changeFunction:"=changeFile"},link:function(a,b){b.bind("change",function(b){var c=b.target.files,d=c[0];a.changeFunction(d)})}}});